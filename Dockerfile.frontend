# Frontend Dockerfile for Vite/Vue app (front/back split)
FROM node:18-alpine AS build

ENV NODE_ENV=production
WORKDIR /app/frontend

# Enable Corepack and use Yarn Classic (v1) for deterministic installs
RUN corepack enable && corepack prepare yarn@1.22.22 --activate \
    && yarn config set registry https://registry.npmmirror.com

# Install deps via Yarn (use lockfile; ensure dev deps for build)
COPY frontend/package.json frontend/yarn.lock ./
RUN yarn install --frozen-lockfile --production=false

# Build assets
COPY frontend/. ./
RUN yarn build

# Runtime image using Nginx to serve static files
FROM nginx:alpine AS runtime
WORKDIR /usr/share/nginx/html

# Copy built assets
COPY --from=build /app/frontend/dist .

# Replace default server config to support SPA history routing
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]