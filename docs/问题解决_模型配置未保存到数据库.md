# 问题解决：模型配置未保存到数据库

## 📋 问题描述

用户报告在前端"设置" → "系统设置"中配置的 `quick_analysis_model` 和 `deep_analysis_model` 没有保存到数据库，导致系统仍然使用默认的 `qwen-turbo` 模型，而不是用户配置的 `qwen-flash` 和 `qwen3-max`。

## 🔍 问题排查过程

### 1. 初步检查

- **前端提交的数据**：确认前端确实提交了这两个字段
  ```json
  {
    "quick_analysis_model": "qwen-flash",
    "deep_analysis_model": "qwen3-max",
    ...
  }
  ```

- **后端接收情况**：添加日志后确认后端成功接收到这两个字段
  ```
  📝 接收到的系统设置更新请求，包含 25 项
    ✓ quick_analysis_model: qwen-flash
    ✓ deep_analysis_model: qwen3-max
  ```

### 2. 深入排查

添加详细日志跟踪配置保存流程：

```python
# app/services/config_service.py - update_system_settings()
📝 更新前 system_settings 包含 33 项
  ✓ 更新前包含 quick_analysis_model: qwen-flash
📝 更新后 system_settings 包含 33 项
  ✓ 更新后包含 quick_analysis_model: qwen-flash
  ✓ 更新后包含 deep_analysis_model: qwen3-max

# app/services/config_service.py - save_system_config()
📝 即将保存的 system_settings 包含 33 项
  ✓ 包含 quick_analysis_model: qwen-flash
  ✓ 包含 deep_analysis_model: qwen3-max
📝 新配置ID: 68e525828f5ef72e9217fa30
✅ 配置保存成功
```

### 3. 发现根本原因

问题出在**数据库查询脚本**上！

**错误的查询方式**：
```python
# scripts/check_provider_values.py (旧版本)
system_config = await db['system_configs'].find_one({})
```

这会返回**第一个**文档（通常是旧的配置），而不是最新的激活配置。

**正确的查询方式**：
```python
# scripts/check_provider_values.py (修复后)
system_config = await db['system_configs'].find_one(
    {"is_active": True},
    sort=[("version", -1)]
)
```

## ✅ 解决方案

### 1. 修复数据库查询脚本

修改 `scripts/check_provider_values.py`，使用正确的查询条件：

```python
# 查询最新的激活配置
system_config = await db['system_configs'].find_one(
    {"is_active": True},
    sort=[("version", -1)]
)
```

### 2. 添加调试日志

在关键位置添加日志，方便后续排查问题：

**app/routers/config.py**：
```python
@router.put("/settings", response_model=dict)
async def update_system_settings(...):
    # 打印接收到的设置
    logger.info(f"📝 接收到的系统设置更新请求，包含 {len(settings)} 项")
    if 'quick_analysis_model' in settings:
        logger.info(f"  ✓ quick_analysis_model: {settings['quick_analysis_model']}")
    if 'deep_analysis_model' in settings:
        logger.info(f"  ✓ deep_analysis_model: {settings['deep_analysis_model']}")
```

**app/services/config_service.py**：
```python
async def update_system_settings(self, settings: Dict[str, Any]) -> bool:
    # 打印更新前后的状态
    print(f"📝 更新前 system_settings 包含 {len(config.system_settings)} 项")
    config.system_settings.update(settings)
    print(f"📝 更新后 system_settings 包含 {len(config.system_settings)} 项")

async def save_system_config(self, config: SystemConfig) -> bool:
    # 打印即将保存的数据
    system_settings = config_dict.get('system_settings', {})
    print(f"📝 即将保存的 system_settings 包含 {len(system_settings)} 项")
```

## 📊 验证结果

修复后，数据库中成功保存了 33 项系统设置：

```json
{
  "max_concurrent_tasks": 3,
  "default_analysis_timeout": 300,
  "enable_cache": true,
  "cache_ttl": 3600,
  "log_level": "INFO",
  "enable_monitoring": true,
  "default_provider": "dashscope",
  "default_model": "qwen-turbo",
  "enable_cost_tracking": true,
  "cost_alert_threshold": 100,
  "currency_preference": "CNY",
  "quick_analysis_model": "qwen-flash",      // ✅ 成功保存
  "deep_analysis_model": "qwen3-max",        // ✅ 成功保存
  "worker_heartbeat_interval_seconds": 30,
  ...
}
```

## 🎯 关键要点

1. **MongoDB 配置版本管理**：
   - 系统使用版本化配置管理，每次更新都会创建新文档
   - 旧配置的 `is_active` 设为 `False`
   - 新配置的 `is_active` 设为 `True`，`version` 递增

2. **正确的查询方式**：
   ```python
   # 始终查询最新的激活配置
   config = await collection.find_one(
       {"is_active": True},
       sort=[("version", -1)]
   )
   ```

3. **配置同步机制**：
   - 数据库 → 文件系统（`config/settings.json`）
   - 数据库 → 环境变量（启动时桥接）
   - 数据库 → 定价配置（`config/pricing.json`）

## 🔧 相关文件

- `app/routers/config.py` - 配置管理 API
- `app/services/config_service.py` - 配置服务
- `app/models/config.py` - SystemConfig 模型定义
- `scripts/check_provider_values.py` - 数据库检查脚本
- `app/core/config_bridge.py` - 配置桥接

## 📝 后续建议

1. **统一查询接口**：创建一个统一的 `get_active_config()` 方法，避免重复代码
2. **添加配置历史查看**：在前端添加配置历史记录功能
3. **配置回滚功能**：支持回滚到之前的配置版本
4. **配置导出/导入**：支持配置的备份和恢复

---

**解决时间**：2025-10-07  
**问题状态**：✅ 已解决

