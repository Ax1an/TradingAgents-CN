# AKShare 请求频率限制测试

## 📋 目的

测试 AKShare（东方财富接口）的请求频率限制，找到最佳的请求间隔，避免连接中断错误。

---

## 🚀 使用方法

### 方法 1：使用 PowerShell 脚本（推荐）

```powershell
.\scripts\test_akshare_rate_limit.ps1
```

**优势**：
- ✅ 自动激活虚拟环境
- ✅ 自动加载 `.env` 文件中的代理配置
- ✅ 一键运行测试

### 方法 2：直接运行 Python 脚本

```powershell
# 激活虚拟环境
.\.venv\Scripts\Activate.ps1

# 运行测试
python scripts\test_akshare_rate_limit.py
```

---

## 📊 测试模式

### 模式 1：快速测试（单次请求）

测试单次请求是否成功，验证基本连接。

**适用场景**：
- 快速验证代理配置是否正确
- 检查 AKShare 接口是否可用

**预期输出**：
```
✅ 请求成功
   数据量: 5000 条
   耗时: 1.23 秒
```

### 模式 2：标准测试（10次连续请求，无间隔）

测试连续请求的成功率，找出是否存在频率限制。

**适用场景**：
- 验证是否存在请求频率限制
- 评估连接稳定性

**预期输出**：
```
总请求次数: 10
成功次数: 7 (70.0%)
失败次数: 3 (30.0%)
平均响应时间: 1.15 秒

失败原因统计:
  • 连接中断: 3 次
```

### 模式 3：完整测试（测试不同间隔，推荐最佳配置）

测试不同的请求间隔（0秒、0.5秒、1秒、2秒、3秒、5秒），找到最佳配置。

**适用场景**：
- 首次配置系统
- 优化实时行情同步性能
- 解决连接中断问题

**预期输出**：
```
📊 不同间隔的测试结果汇总
======================================================================
间隔(秒)   成功次数   失败次数   成功率    
----------------------------------------------------------------------
0          3          2          60.0%
0.5        4          1          80.0%
1          5          0          100.0%
2          5          0          100.0%
3          5          0          100.0%
5          5          0          100.0%

💡 推荐配置
======================================================================
✅ 推荐请求间隔: 1 秒
   在此间隔下，所有请求都成功

   配置建议:
   QUOTES_INGESTION_INTERVAL=30  # 30秒间隔（默认）
```

---

## 🔧 根据测试结果配置系统

### 场景 1：测试结果显示无间隔也能100%成功

**说明**：您的网络环境良好，东方财富服务器没有限制您的请求频率。

**配置建议**：
```bash
# .env 文件
QUOTES_INGESTION_INTERVAL=30  # 保持默认30秒间隔
```

### 场景 2：测试结果显示需要1-2秒间隔

**说明**：东方财富服务器对请求频率有一定限制。

**配置建议**：
```bash
# .env 文件
QUOTES_INGESTION_INTERVAL=60  # 增加到60秒间隔
```

**原因**：
- AKShare 获取实时行情时会分页请求（每页100条，共约50页）
- 如果每次请求需要间隔1秒，那么完整获取一次需要约50秒
- 建议同步间隔设置为60秒以上

### 场景 3：测试结果显示需要3-5秒间隔

**说明**：东方财富服务器对您的IP有较严格的频率限制。

**配置建议**：
```bash
# .env 文件
QUOTES_INGESTION_INTERVAL=300  # 增加到5分钟间隔
```

或者考虑使用 Tushare 数据源（更稳定）：
```bash
TUSHARE_ENABLED=true
TUSHARE_TOKEN=your_token_here
```

### 场景 4：测试结果显示所有请求都失败

**可能原因**：
1. **代理配置问题**：NO_PROXY 未生效，仍然通过代理访问
2. **网络问题**：无法连接到东方财富服务器
3. **IP被封禁**：请求过于频繁，IP被临时封禁

**解决方案**：
1. **检查代理配置**：
   ```powershell
   echo $env:HTTP_PROXY
   echo $env:HTTPS_PROXY
   echo $env:NO_PROXY
   ```

2. **临时禁用代理测试**：
   ```powershell
   $env:HTTP_PROXY = ""
   $env:HTTPS_PROXY = ""
   python scripts\test_akshare_rate_limit.py
   ```

3. **等待一段时间后重试**（如果IP被封禁）

4. **使用 Tushare 数据源**

---

## 📈 测试结果示例

### 示例 1：网络环境良好

```
🧪 测试不同的请求间隔
======================================================================

测试间隔: 0 秒
======================================================================
[1/5] 10:30:15 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.23秒
[2/5] 10:30:16 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.15秒
[3/5] 10:30:17 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.18秒
[4/5] 10:30:18 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.20秒
[5/5] 10:30:19 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.22秒

📊 测试结果统计
======================================================================
总请求次数: 5
成功次数: 5 (100.0%)
失败次数: 0 (0.0%)
平均响应时间: 1.20 秒

💡 推荐配置
======================================================================
✅ 推荐请求间隔: 0 秒
   在此间隔下，所有请求都成功

   配置建议:
   QUOTES_INGESTION_INTERVAL=30  # 30秒间隔（默认）
```

### 示例 2：存在频率限制

```
🧪 测试不同的请求间隔
======================================================================

测试间隔: 0 秒
======================================================================
[1/5] 10:30:15 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.23秒
[2/5] 10:30:16 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.15秒
[3/5] 10:30:17 - 发起请求...
   ❌ 失败 - 连接中断, 耗时: 0.85秒
[4/5] 10:30:18 - 发起请求...
   ❌ 失败 - 连接中断, 耗时: 0.92秒
[5/5] 10:30:19 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.18秒

📊 测试结果统计
======================================================================
总请求次数: 5
成功次数: 3 (60.0%)
失败次数: 2 (40.0%)
平均响应时间: 1.19 秒

失败原因统计:
  • 连接中断: 2 次

======================================================================
测试间隔: 1 秒
======================================================================
[1/5] 10:30:30 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.20秒
   ⏳ 等待 1 秒...
[2/5] 10:30:32 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.18秒
   ⏳ 等待 1 秒...
[3/5] 10:30:34 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.22秒
   ⏳ 等待 1 秒...
[4/5] 10:30:36 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.19秒
   ⏳ 等待 1 秒...
[5/5] 10:30:38 - 发起请求...
   ✅ 成功 - 数据量: 5000 条, 耗时: 1.21秒

📊 测试结果统计
======================================================================
总请求次数: 5
成功次数: 5 (100.0%)
失败次数: 0 (0.0%)
平均响应时间: 1.20 秒

💡 推荐配置
======================================================================
✅ 推荐请求间隔: 1 秒
   在此间隔下，所有请求都成功

   配置建议:
   QUOTES_INGESTION_INTERVAL=60  # 60秒间隔
```

---

## 🔍 常见问题

### Q1：测试时出现 SSL 错误

**原因**：代理配置问题，NO_PROXY 未生效。

**解决方案**：
1. 检查 `.env` 文件中的 `NO_PROXY` 配置
2. 确保使用完整域名（不使用通配符 `*`）
3. 重启测试程序

### Q2：测试时出现代理错误

**原因**：代理服务器无法连接或配置错误。

**解决方案**：
1. 检查代理服务器是否运行
2. 检查 `HTTP_PROXY` 和 `HTTPS_PROXY` 配置是否正确
3. 临时禁用代理测试

### Q3：测试结果不稳定

**原因**：网络波动或服务器负载变化。

**解决方案**：
1. 多次运行测试，取平均值
2. 在不同时间段测试（交易时间 vs 非交易时间）
3. 选择较保守的间隔配置

---

## 📚 相关文档

- [代理配置指南](proxy_configuration.md)
- [定时任务配置指南](scheduled_tasks_configuration.md)
- [AKShare 官方文档](https://akshare.akfamily.xyz/)

---

## 💡 提示

1. **交易时间 vs 非交易时间**：
   - 交易时间（09:30-15:00）：服务器负载高，可能需要更长间隔
   - 非交易时间：服务器负载低，可以使用较短间隔

2. **首次测试建议**：
   - 使用模式 3（完整测试）
   - 在非交易时间测试
   - 根据结果配置系统

3. **定期测试**：
   - 如果发现连接中断错误增多，重新运行测试
   - 根据新的测试结果调整配置

4. **备选方案**：
   - 如果 AKShare 频繁出现问题，考虑使用 Tushare
   - Tushare 需要 Token，但更稳定可靠

